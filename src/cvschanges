#!/usr/bin/env python

"""
A Python script to print out all CVS log entries for only files that
have changed since the last release.  I find it difficult to belive
that "CVS log" doesn't provide this functionality itself, but I can't
for the life of me find it..

To use the script, type:

    src/cvschanges release-<m>-<n>

from the root of the repository.

"""
import sys, os, re

CVSCOMMAND = 'cvs log "-r%s:" 2>/dev/null'

BIGDIV = '='*77
SMALLDIV = '-'*28
def filter_log(log):
    log = re.sub(r'^(\? .*\n)*', '', log).strip()

    # Split into entries.
    entries = log.split(BIGDIV)

    # Strip whitespace
    entries = [entry.strip()+'\n' for entry in entries]

    # Get rid of entries for attic files.
    regexp = re.compile('^.*/Attic/.*')
    entries = [entry for entry in entries if not regexp.match(entry)]

    # Get rid of any entries that have only one revision; they're the
    # borderline cases. (UNLESS IT'S A NEW FILE?!)
    #regexp = re.compile('(.*\n)+?' + SMALLDIV + '\n(.*\n)+?' + SMALLDIV + '\n')
    #entries = [entry for entry in entries if regexp.match(entry)]

    # Get rid of the last revision in each entry; they're the
    # borderline cases. (UNLESS IT'S A NEW FILE?!)
    #entries = [SMALLDIV.join(entry.split(SMALLDIV)[:-1])
    #           for entry in entries]

    # Get rid of head, branch, locks, etc.
    regexp = re.compile(r'Working file:\s+(.*)\n(.*\n)+?total revisions:.*')
    entries = [re.sub(regexp, '', entry) for entry in entries]

    # Get rid fo ",v" :)
    regexp = re.compile(r'RCS file: (.*),v')
    entries = [re.sub(regexp, r'FILE: \1', entry) for entry in entries]

    regexp = re.compile(r'\ndescription:\n')
    entries = [re.sub(regexp, '', entry) for entry in entries]

    # Get rid of revision number, date, etc.
    regexp = re.compile(r'revision (.*)\ndate:.*\n')
    entries = [re.sub(regexp, r'', entry) for entry in entries]
    

#    # Get rid of descriptions.
#    log = re.sub(r'description:\n(.*\n)+?(?=----------------------------)',
#                 '', log)

    # Join the entries back together.
    log = (BIGDIV+'\n').join(entries)
    
    # Get rid of multiple consecutive empty lines
    log = re.sub('\n\n\n+', '\n\n', log)

    return log + BIGDIV + '\n'

def usage(exitval=-1):
    try: print 'Usage: %s <release> <outfile>' % sys.argv[0]
    except: print 'Usage: cvschanges <release> <outfile>' % sys.argv[0]
    sys.exit(exitval)

def main():
    if len(sys.argv) == 3:
        filename = sys.argv[2]
    elif len(sys.argv) == 2:
        filename = '/tmp/changes.cvslog'
    else:
        usage()
        
    command = CVSCOMMAND % sys.argv[1]
    print 'Getting the cvs log...\n    %s' % command
    log = os.popen(command).read()

    print 'Filtering log...'
    log = filter_log(log)

    print 'Writing output to %s...' % filename
    out = open(filename, 'w')
    header = (BIGDIV + '\nParsed CVS log\n%s\n' + BIGDIV + '\n\n')
    header = header % os.path.abspath(os.curdir)
    out.write(header + log)

if __name__ == '__main__':
    main()

